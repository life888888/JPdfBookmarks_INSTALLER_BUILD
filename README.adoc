= JPdfBookmarks INSTALLER BUILD
life888888
:doctype: article
:encoding: utf-8
:lang: en
:toc: left
:numbered:
:experimental:
:imagesdir: images

////
:figure-caption!:
////

This is an auxiliary tool command file used to help jpdfbookmarks create Native Installer (Windows .msi , Linux .rpm , Linux .deb).

The following content is translated from Chinese to English using Google Translate.

== what this aids directive can do

* Generate Native Installer (Windows .msi , Linux .rpm , Linux .deb 
* JRE has been packaged, users do not need to install JRE.
* Users can click on the PDF file in the GUI file manager, click the right mouse button, and the system will pop up Open With, and can use jpdfbookmarks to open the PDF.
* Users can also execute the `jpdfbookmarks_cli` command in the terminal as a command. 
* Wrappers no longer need to pack these files in:
** exe generated by launch4j  (jpdfbookmarks.exe,jpdfbookmarks_cli.exe)
** and jpdfbookmarks, jpdfbookmarks_cli, link_this_in_linux_path.sh, link_this_in_linux_path_cli.sh 
* (Linux) users do not need to do it manually, add the installation directory to the PATH environment variable or 

[source,bash]
----
cd /usr/local/bin
ln -s /home/user/jpdfbookmarks/link_this_in_linux_path.sh jpdfbookmarks
ln -s /home/user/jpdfbookmarks/link_this_in_linux_path_cli.sh jpdfbookmarks_cli
----

== How to use and execute? 

Just download this project, and then execute the corresponding command file according to your needs.

[source,bash]
----
git clone https://github.com/life888888/JPdfBookmarks_INSTALLER_BUILD.git
cd JPdfBookmarks_INSTALLER_BUILD/src
----

== Select the corresponding command file you need to execute according to the options 

* 1. platform ( linux-rpm, linux-deb , windows)
* 2. version ( jpdfbookmarks 2.5.2 , 2.5.4 , 3.0.2)


=== Linux - RPM

==== System requirement

* JDK 17 (Just install it with SDKMAN )
* **Development Tools** must be installed (`sudo yum groupinstall 'Development Tools'`)

The automation instructions have been written as follows:

[source,bash]
----
cd JPdfBookmarks_INSTALLER_BUILD/src
./build-installer-rpm-pre-setup.sh
----

==== Select the version you want to encapsulate, and then execute the corresponding version of the shell script.

[source,bash]
----
# jpdfbookmarks 2.5.2
./build-installer-rpm-2.5.2.sh

# jpdfbookmarks 2.5.4
./build-installer-rpm-2.5.4.sh

# jpdfbookmarks 3.0.2
./build-installer-rpm-3.0.2.sh
----

=== Linux - DEB

==== System requirement

* JDK 17 (Just install it with SDKMAN )

The automation instructions have been written as follows:

[source,bash]
----
cd JPdfBookmarks_INSTALLER_BUILD/src
./build-installer-deb-pre-setup.sh
----

==== Select the version you want to encapsulate, and then execute the corresponding version of the shell script.

[source,bash]
----
# jpdfbookmarks 2.5.2
./build-installer-deb-2.5.2.sh

# jpdfbookmarks 2.5.4
./build-installer-deb-2.5.4.sh

# jpdfbookmarks 3.0.2
./build-installer-deb-3.0.2.sh
----

=== Windows

System requirement:

* JDK 17
* WiX SDK 3.x

==== Install JDK 17

Requires manual execution of the following tasks:

* Download JDK 17 ( https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.2%2B8/OpenJDK17U-jdk_x64_windows_hotspot_17.0.2_8.msi )
* Click OpenJDK17U-jdk_x64_windows_hotspot_17.0.2_8.msi to install JDK 17 
** When installing, please remember to drop down the check box to set JAVA_HOME and Oracle Reg Keys.

==== 安裝 WiX 3.x

The automation instructions have been written as follows:

[source,bash]
----
cd JPdfBookmarks_INSTALLER_BUILD\src
build-installer-msi-pre-setup.bat
----

==== Select the version you want to encapsulate, and then execute the corresponding version of the shell script.

[source,bash]
----
build-installer-msi-2.5.2.bat

build-installer-msi-2.5.4.bat

build-installer-msi-3.0.2.bat
----

At this point, you should be able to complete the packaging of your jpdfbookmarks native installer.

Then there are broken thoughts! If you want more technical details, read further, otherwise you can close this document now. 

== Packaging platform and test platform

* Linux - DEB - Ubuntu 20.04
* Linux - RPM - Oracle Linux 8 (https://oracle.github.io/vagrant-projects/boxes/oraclelinux/8-btrfs.json) 
* Windows 10 - MSEdge on Win10 (x64) Stable 1809 - VirtualBox (https://developer.microsoft.com/microsoft-edge/tools/vms/)


=== Package output of this auxiliary tool

The following outputs are produced through this tool command:

* JPdfBookmarks-2.5.2 (https://github.com/life888888/JPdfBookmarks/releases/tag/v2.5.2)
** jpdfbookmarks-2.5.2-1.x86_64.rpm (https://github.com/life888888/JPdfBookmarks/releases/download/v2.5.2/jpdfbookmarks-2.5.2-1.x86_64.rpm)
** jpdfbookmarks_2.5.2-1_amd64.deb (https://github.com/life888888/JPdfBookmarks/releases/download/v2.5.2/jpdfbookmarks_2.5.2-1_amd64.deb) 
** jpdfbookmarks-2.5.2.msi (https://github.com/life888888/JPdfBookmarks/releases/download/v2.5.2/jpdfbookmarks-2.5.2.msi) 


* JPdfBookmarks-2.5.4 (https://github.com/life888888/JPdfBookmarks/releases/tag/v2.5.4)
** jpdfbookmarks-2.5.4-1.x86_64.rpm (https://github.com/life888888/JPdfBookmarks/releases/download/v2.5.4/jpdfbookmarks-2.5.4-1.x86_64.rpm)
** jpdfbookmarks_2.5.4-1_amd64.deb (https://github.com/life888888/JPdfBookmarks/releases/download/v2.5.4/jpdfbookmarks_2.5.4-1_amd64.deb)
** jpdfbookmarks-2.5.4.msi (https://github.com/life888888/JPdfBookmarks/releases/download/v2.5.4/jpdfbookmarks-2.5.4.msi)


* JPdfBookmarks-3.0.2 (https://github.com/life888888/JPdfBookmarks/releases/tag/v3.0.2-r1-snapshot)
** jpdfbookmarks-3.0.2-snapshot-1.x86_64.rpm (https://github.com/life888888/JPdfBookmarks/releases/download/v3.0.2-r1-snapshot/jpdfbookmarks-3.0.2-snapshot-1.x86_64.rpm)
** jpdfbookmarks_3.0.2-snapshot-1_amd64.deb (https://github.com/life888888/JPdfBookmarks/releases/download/v3.0.2-r1-snapshot/jpdfbookmarks_3.0.2-snapshot-1_amd64.deb)
** jpdfbookmarks-3.0.2.msi (https://github.com/life888888/JPdfBookmarks/releases/download/v3.0.2-r1-snapshot/jpdfbookmarks-3.0.2.msi)

=== Limit

* Windows msi file, when installing, please advise users to change the jpdfbookmarks installation directory to a path that does not contain blank characters, for example:
** C:\TOOLS\jpdfbookmarks
* The Windows msi file currently **does not automatically** add the jpdfbookmarks installation directory to the PATH environment variable, and users need to add it by themselves. 
** If the jpdfbookmarks installation directory is not added to the PATH environment variable, the user cannot directly execute commands like `jpdfbookmarks_cli -d -o INDEX.txt README-zh_TW.pdf` in any directory, and the full path of jpdfbookmarks_cli must be entered, for example `C:\TOOLS\jpdfbookmarks\jpdfbookmarks_cli -d -o INDEX.txt README-en_TW.pdf`
** You can set the PATH environment variable by executing the following command `build-installer-msi-after-install.bat` or `setx PATH "C:\TOOLS\jpdfbookmarks;%PATH%"` 
** Note: When users install jpdfbookmarks-x.x.x.msi, the installation directory must be changed to `C:\TOOLS\jpdfbookmarks` 
* No wrapper directive for MacOS? 
** Yes, no! Because I don't have a MacOS environment to test!!! 

== Testing report

After the installation is complete, how can I verify that it works? Test PDF files can be downloaded from here: (https://github.com/life888888/jpdfbookmarks-test-pdf-examples/releases/download/v1.0.0/jpdfbookmarks-test-pdf-examples-dist-1.0.0.tar.xz)

=== Native Inatller Check Item

- [✓] Does the splash screen appear when jpdfbookmark is executed? 
- [✓] When jpdfbookmark_cli is executed, will a console/terminal window appear?
- [✓] When jpdfbookmark_cli is executed, splash screen should not appear.
- [✓] Whether jpdfbookmark or jpdfbookmark_cli can be executed in any path (whether the PATH setting is successful) - Linux
- [✓] In the file manager, when clicking on a PDF, is it possible to use the right mouse button to display jpdfbookmark? 
- [✓] In the file manager, when you click on the PDF, can you use the right mouse button? In the Open With Application list, is there a jpdfbookmark that can be selected? 

=== Windows

==== Installation screen shot

.Click on jpdfbookmarks-x.x.x.msi to install 
image:win-install-001.png[Click on jpdfbookmarks-x.x.x.msi to install]

.Click Next
image:win-install-002.png[Click Next]

.Click the input box, change the installation directory, enter the installation path, do not include `space` characters.
image:win-install-003.png[Click the input box, change the installation directory, enter the installation path, do not include `space` characters]

.After changing the installation directory to C:\TOOLS\jpdfbookmarks, click Next (as long as the installation path does not contain space char) 
image:win-install-004.png[After changing the installation directory to C:\TOOLS\jpdfbookmarks, click Next]

.Click Next, the default create shortcut is kept checked
image:win-install-005.png[Click Next, the default create shortcut is kept checked]

.Click Install
image:win-install-006.png[Click Install]

.Click Yes, the system asks if you agree to the installer to change the device 
image:win-install-007.png[Click Yes, the system asks if you agree to the installer to change the device ]

.Click Finish to complete the installation of jpdfbookmarks.
image:win-install-008.png[Click Finish to complete the installation of jpdfbookmarks]


[IMPORTANT]
.Because the installer has not been set to automatically add the jpdfbookmarks installation directory to the PATH environment variable. 
====
So we need the user to manually add the jpdfbookmarks installation directory to the PATH environment variable setting.
Please inform users in the installation documentation.

Or let the user open a DOS CMD window and execute this command manually: `build-installer-msi-after-install.bat` or `setx PATH "C:\TOOLS\jpdfbookmarks;%PATH%"`

But the premise is that during the installation process, the installation directory of the modified jpdfbookmarks is `C:\TOOLS\jpdfbookmarks`. 

If the user is set to another installation directory, he must modify the command by himself.
====

==== Test `Open With`

.Click README-zh_TW.pdf, right-click, click Open with, you should see the jpdfbookmarks icon, and `Choose another application` 
image:win-open-with.png[Click README-zh_TW.pdf, right-click, click Open with]


==== First time use, License agreement screen

.For the first time use, the License agreement screen, click Agree 
image:win-license.png[For the first time use, the License agreement screen, click Agree]

.jpdfbookmarks displays PDFs containing Chinese bookmarks normally
image:win-test-001.png[jpdfbookmarks displays PDFs containing Chinese bookmarks normally]

Only jpdfbookmarks 2.5.4 / 3.0.2 can display bookmarks with Chinese characters normally, other versions only display Chinese, Japanese, Korean, etc. as tofu character.

=== Test console / terminal mode 

.Open the DOS CMD window and enter the command: `jpdfbookmarks_cli -e UTF-8 -d -o INDEX.txt README-zh_CN.pdf` 
image:win-test-002.png[Open the DOS CMD window and enter the command]

.Modify INDEX.txt, input command: `jpdfbookmarks_cli -e UTF-8 -a INDEX.txt -o README-zh_CN_NEW.pdf README-zh_CN.pdf` to generate a new PDF file with bookmarks applied.
image:win-test-003.png[Modify INDEX.txt, input command]

.View bookmarks in README-zh_CN_NEW.pdf is the new setting (INDEX.txt) 
image:win-test-004.png[View bookmarks in README-zh_CN_NEW.pdf is the new setting (INDEX.txt)]

=== Linux - RPM

==== Installation screen shot

.Select jpdfbookmarks-x.x.x.rpm, right click `Open with Software install` 
image:linux-rpm-install-001.png[Select jpdfbookmarks-x.x.x.rpm, right click `Open with Software install`]

Or execute the command to install `sudo yum localinstall -y jpdfbookmarks-3.0.2-snapshot-1.x86_64.rpm` 

.The Software window appears, click Install to install.
image:linux-rpm-install-002.png[click Install]

==== Test `Open With`

.Click README.pdf , right-click, `Open With jpdfbookmarks` and `Open With Other Application` will appear.
image:linux-rpm-open-with.png[Click README.pdf , right-click, `Open With jpdfbookmarks` and `Open With Other Application` will appear.]

.Click `Open With Other Application`, the Select Application window appears, the list below appears jpdfbookmarks, jpdfbookmarks_cli, click **jpdfbookmarks** 
image:linux-rpm-open-with-2.png[Click `Open With Other Application`, the Select Application window appears, the list below appears jpdfbookmarks, jpdfbookmarks_cli]

==== First time use, License agreement screen

.For the first time use, the License agreement screen, click Agree 
image:linux-rpm-license.png[.For the first time use, the License agreement screen, click Agree ]


==== jpdfbookmarks GUI

.The screen that jpdfbookmarks opens README.pdf appears 
image:linux-rpm-test-001.png[The screen that jpdfbookmarks opens README.pdf appears]

==== Test jpdfbooks_cli Console/Terminal mode 

.Open Terminal: right-click, select `Open Terminal` 
image:linux-rpm-test-002.png[Open Terminal: right-click, select `Open Terminal`]

.Enter the command `jpdfbookmarks cli --help`, if there is a message as shown in the figure, it means that the settings of the installer are normal.
image:linux-rpm-test-003.png[Enter the command `jpdfbookmarks cli --help`]

.Input command ‵jpdfbookmarks_cli -d -o INDEX.txt README-zh_TW.pdf‵ output INDEX.txt
image:linux-rpm-test-004.png[Input command ‵jpdfbookmarks_cli -d -o INDEX.txt README-zh_TW.pdf‵ output INDEX.txt]

.Open INDEX.txt, you can see that there are normal output bookmarks 
image:linux-rpm-test-005.png[Open INDEX.txt, you can see that there are normal output bookmarks]

image:linux-rpm-test-006.png[]

image:linux-rpm-test-007.png[]

.Deliberately input a non-existing pdf as a test, `jpdfbookmarks_cli xxx.pdf`, you can go to the HOME directory to find `jpdfbookmarks.0.log` Check the content of the error message 
image:linux-rpm-test-008.png[Deliberately input a non-existing pdf as a test, `jpdfbookmarks_cli xxx.pdf`]

==== test screen shot


=== Linux - DEB

==== installation screen shot

You can install it directly using the command: `sudo dpkg -i jpdfbookmarks_x.x.x.deb`, 

For example: ‵sudo dpkg -i jpdfbookmarks_3.0.2-snapshot-1_amd64.deb‵ 


==== Test Open With 

.Click README-zh_TW.pdf, click the right mouse button, there will be `Open With Other Application`
image:linux-deb-open-with.png[Click README-zh_TW.pdf, click the right mouse button, there will be `Open With Other Application`]

.Select the application window, click jpdfbookmarks, click Select 
image:linux-deb-open-with-2.png[Select the application window, click jpdfbookmarks, click Select]

==== First time use, License agreement screen 

.For the first time use, the License agreement screen, click Agree 
image:linux-deb-license.png[For the first time use, the License agreement screen, click Agree)]

==== Chinese Bookmarks display normal

.Chinese Bookmarks display normal screen shot, only jpdfbookmarks 2.5.4, 3.0.2 can display Chinese/Japanese/Korean Bookmarks normally. 
image:fix.png[Chinese Bookmarks display normal screen shot, only jpdfbookmarks 2.5.4, 3.0.2 can display Chinese/Japanese/Korean Bookmarks normally. ]

If you want jpdfbookmarks to display Chinese/Japanese/Korean, please download here: 

* JPdfBookmarks-2.5.4 (https://github.com/life888888/JPdfBookmarks/releases/tag/v2.5.4)
* JPdfBookmarks-3.0.2 (https://github.com/life888888/JPdfBookmarks/releases/tag/v3.0.2-r1-snapshot)

==== Check jpdfbookmarks version 

.Click Menu Help, click About 
image:linux-deb-about-3.0.2_1.png[Click Menu Help, click About]

.The version number appears 
image:linux-deb-about-3.0.2_2.png[The version number appears]

== TODO

- [ ] msi for Windows: Modify the settings in WiX so that the msi installation file can automatically add the installation directory of jpdfbookmarks to the PATH environment variable after the installation is complete. I have not found out how to complete this part. 

- [ ] MacOS packaging: I will talk about it later if I have a MacOS environment!!! 

== Technical point description 

In this project, the relevant technical points that can be learned are described as follows: 

=== JPackage

In this project, the jpackage function built into JDK is mainly used. 

Restriction of jpackage: Only the corresponding native installer file can be generated on a single platform (host os). 

* In Linux (deb - Ubuntu), only .deb files can be generated, and installation files in .rpm, .msi and other formats cannot be generated.
* In Linux (rpm - Oracle Linux, Red Hat Linux), only .rpm files can be generated, and installation files in .deb, .msi and other formats cannot be generated. 
* In Windows, only .msi or .exe files can be generated, and installation files in .deb, .rpm and other formats cannot be generated. 

Therefore, if you want to generate installation files corresponding to different platforms, you must go to different platforms to generate corresponding native installers one by one. 

In addition, some parameters of jpakcage correspond to specific platforms. If Linux-specific parameters are given on the windows platform, an error will occur, resulting in failure to package the native installer file.

Also like the --icon parameter, Windows only accepts .ico file format, while Linux platform only accepts .png file format. 

=== Open With function

To let the operating system know what mime type and what program to open a certain format (.pdf or .html), we can use `--file-associations jpdfbookmarks.mime.properties` to specify the relevant settings in an external file , the format is as follows: 


[source,bash]
.jpdfbookmarks.mime.properties
----
mime-type=application/pdf
extension=pdf
description=PDF
----

Here is just to tell the OS that our jpdfbookmarks can handle pdf.

But the linux operating system does not add jpdfbookmarks to Open With. 

So we overwrite the original .desktop file. Please note the `%f` inside, be sure to add it. In order to allow the operating system to have Open With or Open With Other Application can appear in the system menu. 

[source,bash]
.jpdfbookmarks.desktop
----
[Desktop Entry]
Name=jpdfbookmarks
Comment=jpdfbookmarks
Exec=/opt/jpdfbookmarks/bin/jpdfbookmarks %f
Icon=/opt/jpdfbookmarks/lib/jpdfbookmarks.png
Terminal=false
Type=Application
Categories=Office
MimeType=application/pdf
----


[source,bash]
.jpdfbookmarks_cli.desktop
----
[Desktop Entry]
Name=jpdfbookmarks
Comment=jpdfbookmarks
Exec=/opt/jpdfbookmarks/bin/jpdfbookmarks %f
Icon=/opt/jpdfbookmarks/lib/jpdfbookmarks.png
Terminal=true
Type=Application
Categories=Office
MimeType=application/pdf
----


=== second launcher 

jpackage defaults to only have one launcher point, but JPdfBookmarks has a jpdfbookmarks_cli in addition to jpdfbookmarks,
It must be terminal / console , and must be no splash splash screen. 

We use `--add-launcher jpdfbookmarks_cli=jpdfbookmarks_cli.linux.launcher`
or `--add-launcher jpdfbookmarks_cli=jpdfbookmarks_cli.windows.launcher`
to let jpackage know to add a second set of startup programs `jpdfbookmarks_cli` 


[source,bash]
.jpdfbookmarks_cli.windows.launcher
----
win-console=true
java-options="-Djava.util.logging.config.file=$APPDIR/conf/jpdfbookmarks.logging.properties" "-splash:" "-ms64m" "-mx512m"
----
Note that the value of win-console in windows is set to true, which is used to tell the jpdfbookmarks program to start with a console.
In addition, the parameters after java-options can be placed in multiple, use `"` to wrap, and use ` ` (space) to separate multiple parameters 


[source,bash]
.jpdfbookmarks_cli.linux.launcher
----
java-options="-Djava.util.logging.config.file=$APPDIR/conf/jpdfbookmarks.logging.properties" "-splash:" "-ms64m" "-mx512m"
----

But like in Linux there is no one called linux console, this part actually needs to be modified through the .desktop file.

Note: the following setting `Terminal=true`.

[source,bash]
.jpdfbookmarks_cli.desktop
----
[Desktop Entry]
Name=jpdfbookmarks
Comment=jpdfbookmarks
Exec=/opt/jpdfbookmarks/bin/jpdfbookmarks %f
Icon=/opt/jpdfbookmarks/lib/jpdfbookmarks.png
Terminal=true
Type=Application
Categories=Office
MimeType=application/pdf
----


=== Make programs automatically added to PATH (Linux) 

I found
 
* Linux - Deb is to be added after installation through `postinst`, `postrm` is removed after removal.
* Linux - Rpm is added and removed through `jpdfbookmarks.spec`.

==== Linux - Deb

[source,bash]
.postinst
----
...
case "$1" in
    configure)
xdg-desktop-menu install /opt/jpdfbookmarks/lib/jpdfbookmarks-jpdfbookmarks.desktop
xdg-mime install /opt/jpdfbookmarks/lib/jpdfbookmarks-jpdfbookmarks-MimeInfo.xml
xdg-desktop-menu install /opt/jpdfbookmarks/lib/jpdfbookmarks-jpdfbookmarks_cli.desktop
        # register /usr/bin/jpdfbookmarks as a jpdfbookmarks in the alternatives system
        update-alternatives \
            --install \
                /usr/bin/jpdfbookmarks \
                jpdfbookmarks \
                /opt/jpdfbookmarks/bin/jpdfbookmarks \
                50 
        # register /usr/bin/jpdfbookmarks_cli as a jpdfbookmarks_cli in the alternatives system
        update-alternatives \
            --install \
                /usr/bin/jpdfbookmarks_cli \
                jpdfbookmarks_cli \
                /opt/jpdfbookmarks/bin/jpdfbookmarks_cli \
                50      
    ;;
...
----


[source,bash]
.postrm
----
...
case "$1" in
    purge|remove)
           update-alternatives --remove jpdfbookmarks /usr/bin/jpdfbookmarks || true 
           update-alternatives --remove jpdfbookmarks_cli /usr/bin/jpdfbookmarks_cli || true            
    ;;
...
----


==== Linux - Rpm


[source,bash]
.jpdfbookmarks.spec
----
...
%post
xdg-desktop-menu install /opt/jpdfbookmarks/lib/jpdfbookmarks-jpdfbookmarks.desktop
xdg-mime install /opt/jpdfbookmarks/lib/jpdfbookmarks-jpdfbookmarks-MimeInfo.xml
xdg-desktop-menu install /opt/jpdfbookmarks/lib/jpdfbookmarks-jpdfbookmarks_cli.desktop
        # register /usr/bin/jpdfbookmarks as a jpdfbookmarks in the alternatives system
        update-alternatives \
            --install \
                /usr/bin/jpdfbookmarks \
                jpdfbookmarks \
                /opt/jpdfbookmarks/bin/jpdfbookmarks \
                50 
        # register /usr/bin/jpdfbookmarks_cli as a jpdfbookmarks in the alternatives system
        update-alternatives \
            --install \
                /usr/bin/jpdfbookmarks_cli \
                jpdfbookmarks_cli \
                /opt/jpdfbookmarks/bin/jpdfbookmarks_cli \
                50
...
xdg-desktop-menu uninstall /opt/jpdfbookmarks/lib/jpdfbookmarks-jpdfbookmarks.desktop
xdg-mime uninstall /opt/jpdfbookmarks/lib/jpdfbookmarks-jpdfbookmarks-MimeInfo.xml
uninstall_default_mime_handler jpdfbookmarks-jpdfbookmarks.desktop application/pdf
xdg-desktop-menu uninstall /opt/jpdfbookmarks/lib/jpdfbookmarks-jpdfbookmarks_cli.desktop
update-alternatives --remove jpdfbookmarks /usr/bin/jpdfbookmarks || true 
update-alternatives --remove jpdfbookmarks_cli /usr/bin/jpdfbookmarks_cli || true    
...
----

Sorry, but haven't found Wix how to add to the PATH.


=== Let jpackage override the default with a custom file

We use `--resource-dir linuxOverride` to specify where is the archive directory to overwrite!!! 

* Linux can use custom files section containing `launcher.png`, `launcher.desktop`.
** Note: The launcher here should be replaced with app name , such as jpdfbookmarks, jpdfbookmarks_cli , so the corresponding file will be
  jpdfbookmarks.png, jpdfbookmarks_cli.png , jpdfbookmarks.desktop, jpdfbookmarks_cli.desktop.

* Linux DEBs can use custom file sections containing `control`, `preinst`, `prerm`, `postinst`, `postrm`, `copyright`.

* Linux RPMs can use the custom file section to include `package-name.spec`, where the package-name is the same as the app name, so it will be jpdfbookmarks.spec.

There is no research on the override of Windows and MacOS. 

=== How do I know which files to overwrite? 

When executing jpackage, just add `--temp xxxx`, you can find the file that jpackage needs to package according to your parameters in the xxxx directory, we can copy the part that needs to be modified, and then modify it.

I copied the modified part to the linux Override directory.

The aforementioned `jpdfbookmarks.desktop`, `jpdfbookmarks_cli.desktop` and `postinst`, `postrm`, `jpdfbookmarks.spec` are copied from jpackage plus `--temp xxxx` output xxxx subdirectory, be modified. 

[IMPORTANT]
.limit
====
* If we change the app name and launcher name, the files in the corresponding build image will also be changed.
Please remember to redo --temp xxxx , copy the related files such as `xxxxx.desktop`, `yyyyy_cli.desktop` and `postinst`, `postrm` , `xxxxx.spec` and other files to modify.
* In addition, it is recommended to use **lowercase** for the name 
====


=== Restrictions - jpdfbookmarks.spec

`Version: 3.0.2` is written in jpdfbookmarks.spec, I have to copy multiple files with the same content, and then modify `Version: xxx`, so I have `jpdfbookmarks.spec.2.5.2`, `jpdfbookmarks .spec.2.5.4`, `jpdfbookmarks.spec.3.0.2`
Before executing, copy `jpdfbookmarks.spec.2.5.2` to `jpdfbookmarks.spec` 


=== Refinement of JRE Runtime image 

If no additional parameters are set, jpackage will automatically package jre for you. 

But jpackage can decide which modules to package according to the given module in ‵--add-modules‵. 

The msi/deb/rpm of jpdfbookmarks with the ‵--add-modules‵ parameter can be changed from 58 MB to 34 MB. 

==== How to know which modules to add to add-modules? 

[source,bash]
.Find out which modules are required by jpdfbookmarks.jar.
----
jdeps -cp "lib/*" \
    --module-path "lib/*" \
    --multi-release 9 \
    --print-module-deps \
    --ignore-missing-deps \
    jpdfbookmarks.jar 
----

Then go to the lib directory and use the jars in it to find the corresponding module with instructions similar to the above

Finally, sort them out, and then use `,` to separate them. 

==== **Yes** no need to pre-generate jre runtime with jlinks 

Adding the parameter ‵--add-modules‵ directly to jpackage will allow the simplified jre image to be applied. 


=== Does not need to be a JDK 9 compiled and packaged Java application to use \

In this project, we directly download jpdfbookmarks 2.5.2 (compiled and packaged with Java 6), unpack it, and then use the jpackage command to repackage it.

So regardless of whether your program is compiled and packaged with JDK 9+, you can use jpackage to repackage the native installer.

=== Java Options And Splash Screen

You can use java-options to specify parameters that would otherwise be given by external parameters, such as `-DXXXXX` , `-mxXXXm`, `-msXXXm`.

[source,bash]
----
--java-options "-Djava.util.logging.config.file=$APPDIR/conf/jpdfbookmarks.logging.properties"
--java-options "-splash:$APPDIR/splash.png"
--java-options "-ms64m"
--java-options "-mx512m"
----

In addition, it should be noted that the Splash screen, if it was originally set in the main jar, will not take effect here, and must be given through the java-options parameter.
Alternatively, you can use the `$APPDIR` proxy to wrap the installation directory.
[source,bash]
----
--java-options "-splash:$APPDIR/splash.png"
----

=== A big `pit` in the testing process

Out-of-the-box vagrant box settings to use when testing jpackage with Oracle Linux (RPM) :

[source,bash]
----
$ mkdir VM_oraclelinux_8-btrfs
$ cd VM_oraclelinux_8-btrfs
$ vagrant init oraclelinux/8-btrfs https://oracle.github.io/vagrant-projects/boxes/oraclelinux/8-btrfs.json
$ vagrant up
$ vagrant ssh
...
----

Using `jpackage` always reports an error: 
 `Error: Invalid or unsupported type: [null]` or `Error: Invalid or unsupported type: [rpm]`

This error, originally thought to be related to using SDKMAN to install jdk, and later using yum install java-17* is no solution!!! 

The final solution is: To install 'Development Tools' the command is `sudo yum groupinstall 'Development Tools'`.

Here it is organized in `build-installer-rpm-pre-setup.sh`.

== Command simplification 

* Extract the platform-related parameters to an external file, use @XXXX ,
* Make the command body almost similar, separate the platform-specific or format-related ones in external files,
* In addition, the command body extracted from the version-specific part: 

[source,bash]
.deb build
----
jpackage @jpdfbookmarks.app.jpackage.settings \
 @jpdfbookmarks.linux.jpackage.settings  \
 --add-launcher jpdfbookmarks_cli=jpdfbookmarks_cli.linux.launcher  \
 --linux-app-release snapshot-1 \
 --linux-deb-maintainer "Flaviano Petrocchi<flavianopetrocchi@gmail.com>" \
 --app-version 3.0.2 \
 --add-modules  java.base,java.datatransfer,java.desktop,java.logging,java.management,java.naming,java.prefs,java.sql,java.xml
----

[source,bash]
.rpm build
----
jpackage @jpdfbookmarks.app.jpackage.settings \
 @jpdfbookmarks.linux.jpackage.settings  \
 --add-launcher jpdfbookmarks_cli=jpdfbookmarks_cli.linux.launcher  \
 --linux-app-release snapshot-1 \
 --app-version 3.0.2 \
 --add-modules  java.base,java.datatransfer,java.desktop,java.logging,java.management,java.naming,java.prefs,java.sql,java.xml
----

[source,bash]
.msi build
----
jpackage @jpdfbookmarks.app.jpackage.settings ^
 @jpdfbookmarks.windows.jpackage.settings ^
 --add-launcher jpdfbookmarks_cli=jpdfbookmarks_cli.windows.launcher  ^
 --app-version 3.0.2 ^
 --add-modules   java.base,java.datatransfer,java.desktop,java.logging,java.management,java.naming,java.prefs,java.sql,java.xml
----



== Reference sources 

* Packaging Tool User's Guide(https://docs.oracle.com/en/java/javase/17/jpackage/packaging-tool-user-guide.pdf)

* jpackage instruction description  (https://docs.oracle.com/en/java/javase/17/docs/specs/man/jpackage.html)

== Summarize

* In this project, you can use this project to help you repackage jpdfbookmarks' native installer on your machine.
* The new Native Installer allows you to use `Open With` after installation, use the file manager, and click on the PDF.
* The new Native Installer allows you to install without having to set `PATH` or to link to `/usr/bin` (Linux).
* There are also the `pit` encountered in the execution of jpackage in Linux - RPM and the solution I found by myself
* In this project, the different aspects of parameter usage of multiple jpackages are shown, so that you can better understand the meaning of the parameters in the file!!! 
